{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
    <h1>Welcome to Pixel Art App</h1>
    <p style="text-align: center;">Upload or draw pixel art for your ESP32!</p>
    
    <h2>Gallery</h2>

    <div class="filter-controls" style="text-align: center; margin-bottom: 20px;">
        <label for="displayFilter">Filter by Display:</label>
        <select id="displayFilter" onchange="filterGallery()">
            <option value="all">All</option>
            {% for display in displays %}
                <option value="{{ display.name }}">{{ display.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="gallery-grid" id="gallery">
        <!-- Images will be loaded here via JS -->
    </div>

    <script>
        let allImages = [];

        function renderGallery(images) {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';

            if (images.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.style.textAlign = 'center';
                emptyMessage.style.gridColumn = '1 / -1';
                emptyMessage.innerHTML = '<p>No images found. <a href="{{ url_for("main.draw") }}">Draw one!</a></p>';
                gallery.appendChild(emptyMessage);
                return;
            }

            images.forEach(img => {
                const item = document.createElement('div');
                item.className = 'gallery-item';

                // Image Container
                const imgContainer = document.createElement('div');
                imgContainer.className = 'gallery-image-container';

                const link = document.createElement('a');
                link.href = img.url;
                link.target = "_blank";

                const image = document.createElement('img');
                image.src = img.url;
                image.alt = img.filename;

                link.appendChild(image);
                imgContainer.appendChild(link);
                item.appendChild(imgContainer);

                // Info Container
                const info = document.createElement('div');
                info.className = 'gallery-info';

                // Display Name (Title)
                const title = document.createElement('div');
                title.className = 'gallery-title';
                title.textContent = img.display_name || 'Untitled';
                info.appendChild(title);

                // Metadata
                const meta = document.createElement('div');
                meta.className = 'gallery-meta';

                const dimText = document.createElement('span');
                dimText.textContent = `Size: ${img.width}x${img.height}`;
                meta.appendChild(dimText);

                const userText = document.createElement('span');
                userText.textContent = `By: ${img.username || 'Unknown'}`;
                meta.appendChild(userText);

                info.appendChild(meta);
                item.appendChild(info);

                gallery.appendChild(item);
            });
        }

        function filterGallery() {
            const filterValue = document.getElementById('displayFilter').value;
            let filteredImages = [];

            if (filterValue === 'all') {
                filteredImages = allImages;
            } else {
                filteredImages = allImages.filter(img => img.display_name === filterValue);
            }
            renderGallery(filteredImages);
        }

        fetch('{{ url_for("api.api_list_images") }}')
            .then(response => response.json())
            .then(data => {
                allImages = data.images;
                renderGallery(allImages);
            })
            .catch(err => console.error('Error loading gallery:', err));
    </script>
{% endblock %}
