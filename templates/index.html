{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
    <h1>Welcome to Pixel Art App</h1>
    <p style="text-align: center;">Upload or draw pixel art for your ESP32!</p>
    
    <h2>Gallery</h2>

    <div style="text-align: center; margin-bottom: 20px;">
        <label for="displayFilter">Filter by Display:</label>
        <select id="displayFilter" onchange="filterGallery()">
            <option value="all">All</option>
            {% for display in displays %}
                <option value="{{ display.name }}">{{ display.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="gallery" id="gallery">
        <!-- Images will be loaded here via JS -->
    </div>

    <script>
        let allImages = [];

        function renderGallery(images) {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';

            if (images.length === 0) {
                // Only show this message if we have NO images at all, or if filtering resulted in none.
                // But if we're filtering, maybe we just show "No images for this display".
                // For now, let's keep it simple.
                gallery.innerHTML = '<p>No images found. <a href="{{ url_for("draw") }}">Draw one!</a></p>';
                return;
            }

            images.forEach(img => {
                const item = document.createElement('div');
                item.className = 'gallery-item';

                let displayText = img.display_name ? img.display_name : 'Unknown';

                item.innerHTML = `
                    <a href="${img.url}" target="_blank">
                        <img src="${img.url}" alt="${img.filename}">
                    </a>
                    <br>
                    <small>${img.width}x${img.height}</small><br>
                    <small>${displayText}</small>
                `;
                gallery.appendChild(item);
            });
        }

        function filterGallery() {
            const filterValue = document.getElementById('displayFilter').value;
            let filteredImages = [];

            if (filterValue === 'all') {
                filteredImages = allImages;
            } else {
                filteredImages = allImages.filter(img => img.display_name === filterValue);
            }
            renderGallery(filteredImages);
        }

        fetch('{{ url_for("api_list_images") }}')
            .then(response => response.json())
            .then(data => {
                allImages = data.images;
                renderGallery(allImages);
            })
            .catch(err => console.error('Error loading gallery:', err));
    </script>
{% endblock %}
