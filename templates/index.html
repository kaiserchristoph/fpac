{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
    <h1>Welcome to Pixel Art App</h1>
    <p style="text-align: center;">Upload or draw pixel art for your ESP32!</p>
    
    <h2>Gallery</h2>

    <div style="text-align: center; margin-bottom: 20px;">
        <label for="displayFilter">Filter by Display:</label>
        <select id="displayFilter" onchange="filterGallery()">
            <option value="all">All</option>
            {% for display in displays %}
                <option value="{{ display.name }}">{{ display.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="gallery" id="gallery">
        <!-- Images will be loaded here via JS -->
    </div>

    <script>
        let allImages = [];

        function renderGallery(images) {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';

            if (images.length === 0) {
                // Only show this message if we have NO images at all, or if filtering resulted in none.
                // But if we're filtering, maybe we just show "No images for this display".
                // For now, let's keep it simple.
                gallery.innerHTML = '<p>No images found. <a href="{{ url_for("draw") }}">Draw one!</a></p>';
                return;
            }

            images.forEach(img => {
                const item = document.createElement('div');
                item.className = 'gallery-item';

                let displayText = img.display_name ? img.display_name : 'Unknown';

                // Create link
                const link = document.createElement('a');
                link.href = img.url;
                link.target = "_blank";

                // Create image
                const image = document.createElement('img');
                image.src = img.url;
                image.alt = img.filename;

                link.appendChild(image);
                item.appendChild(link);

                item.appendChild(document.createElement('br'));

                // Create dimensions text
                const dimText = document.createElement('small');
                dimText.textContent = `${img.width}x${img.height}`;
                item.appendChild(dimText);

                item.appendChild(document.createElement('br'));

                // Create display text - use textContent to prevent XSS
                const nameText = document.createElement('small');
                nameText.textContent = displayText;
                item.appendChild(nameText);
                gallery.appendChild(item);
            });
        }

        function filterGallery() {
            const filterValue = document.getElementById('displayFilter').value;
            let filteredImages = [];

            if (filterValue === 'all') {
                filteredImages = allImages;
            } else {
                filteredImages = allImages.filter(img => img.display_name === filterValue);
            }
            renderGallery(filteredImages);
        }

        fetch('{{ url_for("api_list_images") }}')
            .then(response => response.json())
            .then(data => {
                allImages = data.images;
                renderGallery(allImages);
            })
            .catch(err => console.error('Error loading gallery:', err));
    </script>
{% endblock %}
